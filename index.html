<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      html,
      body {
        padding: 0;
        margin: 0;
        overflow-x: hidden;
        overscroll-behavior: none;
      }

      body.overflow-y {
        height: 100vh;
        overflow-y: hidden;
      }

      #box {
        position: relative;
        width: 100vw;
        height: 100vh;
        background-color: #eee;
      }

      .loader-box {
        position: relative;
        top: -80px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 80px;
        background-color: #fff;
      }

      #loader {
        width: 25px;
        height: 25px;
        border: 3px solid #ddd;
        border-radius: 50%;
        border-bottom: 3px solid #1e80ff;
        transform: rotate(0deg);
      }

      #loader.loading {
        animation: loading 1s linear infinite;
      }

      @keyframes loading {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }

      .tip {
        text-align: center;
        font-size: 40px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="box">
      <div class="loader-box">
        <div id="loader"></div>
      </div>
      <div class="tip">下拉刷新 ↓</div>
    </div>
    <script>
      const box = document.getElementById("box");
      const loader = document.getElementById("loader");
      const body = document.body;

      let startX = 0,
        startY = 0,
        endX = 0,
        endY = 0,
        distanceY = 0,
        loadLock = false

      const DISTANCE_Y_LIMIT = window.screen.height / 2;

      if (body.scrollTop === 0) {
        addTouchEvent()
      }

      window.onscroll = function () {
        if (body.scrollTop <= 0) {
          body.scrollTop = 0;
          addTouchEvent();
        }
      };

      function start(e) {
        const { clientX, clientY } = e.touches[0];
        startX = clientX;
        startY = clientY;
      }

      function move(e) {
        if (loadLock) {
          return
        }
        const { clientX, clientY } = e.touches[0];
        endX = clientX;
        endY = clientY;
        if (endY - startY < 0) {
          removeTouchEvent();
          if (body.scrollTop === 0) {
            addTouchEvent();
          }
          return
        }
        distanceY = endY - startY;
        percent = (100 - distanceY * 0.5) / 100;
        percent = Math.max(0.5, percent);
        distanceY = distanceY * percent;
        distanceY = Math.min(distanceY, DISTANCE_Y_LIMIT);
        box.style = `transform: translateY(${distanceY}px); transition: all 0.3s;`;

        e.preventDefault();
      }

      function end() {
        if (loadLock) {
          return
        }
        if (endY - startY < 0) {
          return
        }
        if (distanceY < 80) {
          box.style = `transform: translateY(0); transition: all 0.3s;`;
          body.className = "";
          loader.className = "";
          loadLock = false;
          return
        }
        loadLock = true;
        box.style = `transform: translateY(${80}px); transition: all 0.3s;`;
        body.className = "overflow-y";
        loader.className = "loading";
        loadData();
      }

      function loadData() {
        setTimeout(() => {
          box.style = `transform: translateY(0); transition: all 0.3s;`;
          body.className = "";
          loader.className = "";
          loadLock = false;
        }, 1000)
      }

      function addTouchEvent() {
        box.addEventListener("touchstart", start, { passive: false });
        box.addEventListener("touchmove", move, { passive: false });
        box.addEventListener("touchend", end, { passive: false });
      }

      function removeTouchEvent() {
        box.addEventListener("touchstart", start);
        box.addEventListener("touchmove", move);
        box.addEventListener("touchend", end);
      }
    </script>
  </body>
</html>
