"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([["1751"],{97132:function(e,n,s){s.r(n),s.d(n,{default:()=>h});var a=s("85893"),t=s("50065"),r=s("95895");let i=s.p+"static/image/oss1.1209815e.png",c=s.p+"static/image/oss2.0fe1eea9.png",l=s.p+"static/image/oss3.32a90d89.png",o=s.p+"static/image/oss4.aeba35ba.png";function d(e){let n=Object.assign({h1:"h1",a:"a",p:"p",code:"code",img:"img",ul:"ul",li:"li",h2:"h2",pre:"pre"},(0,t.ah)(),e.components);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.h1,{id:"oss",children:[(0,a.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#oss",children:"#"}),"oss"]}),"\n",(0,a.jsx)(r.Z,{defaultLocale:"zh-CN"}),"\n",(0,a.jsxs)(n.p,{children:["首先需要到阿里云的",(0,a.jsx)(n.code,{children:"身份管理/用户"}),"中创建一个用户账号，"]}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:i})}),"\n",(0,a.jsx)(n.p,{children:"创建好用户后，我们可以给这个用户账号创建 AccessKey，这样就可以拿用户账号访问阿里云的 API 了。"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:c})}),"\n",(0,a.jsx)(n.p,{children:"有两种 API 上传图片到阿里云的方式。"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["服务端转发","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"用服务端转发的话，请求我们自己的服务器会被收取一次费用，上传图片又会再收取一次费用"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["Web 直传","\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"服务端会生成一个签名，然后将签名传递给客户端"}),"\n",(0,a.jsx)(n.li,{children:"客户端通过签名，上传图片到阿里云 OSS"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["我们这里选择 Web 直传的方式，文档可以参考",(0,a.jsx)(n.a,{href:"https://help.aliyun.com/document_detail/31926.html",target:"_blank",rel:"noopener noreferrer",children:"服务端签名后直传"})]}),"\n",(0,a.jsx)(n.p,{children:"之后需要给用户组设置权限。"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:l})}),"\n",(0,a.jsx)(n.p,{children:"然后需要设置跨域"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.img,{src:o})}),"\n",(0,a.jsx)(n.p,{children:"之后读和写都需要权限，我们这里需要设置公共读"}),"\n",(0,a.jsx)(n.p,{children:(0,a.jsx)(n.a,{href:"https://help.aliyun.com/document_detail/177701.html?spm=a2c4g.149373.0.0.318f1955bLrLYc",target:"_blank",rel:"noopener noreferrer",children:"https://help.aliyun.com/document_detail/177701.html?spm=a2c4g.149373.0.0.318f1955bLrLYc"})}),"\n",(0,a.jsxs)(n.h2,{id:"服务端获取签名",children:[(0,a.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#服务端获取签名",children:"#"}),"服务端获取签名"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",meta:"",children:"import { Injectable } from '@nestjs/common';\nimport * as OSS from 'ali-oss';\nimport * as dayjs from 'dayjs';\n\nimport {\n  aliyunAccessKeyId,\n  aliyunAccessKeySecret,\n  aliyunBucket,\n} from 'src/password.config';\nimport { OSSType } from './dto/oss.type';\n\n@Injectable()\nexport class OSSService {\n  async getSignature(): Promise<OSSType> {\n    const config = {\n      accessKeyId: aliyunAccessKeyId,\n      accessKeySecret: aliyunAccessKeySecret,\n      bucket: aliyunBucket,\n      dir: 'images/',\n    };\n    const client = new OSS(config);\n    const date = new Date();\n    date.setDate(date.getDate() + 1);\n    const policy = {\n      expiration: date.toISOString(), // 请求的超时时间。\n      conditions: [\n        ['content-length-range', 0, 1048576], // 设置上传文件的大小限制 1MB\n      ],\n    };\n\n    // 调用SDK获取签名\n    const formData = await client.calculatePostSignature(policy);\n\n    return {\n      expire: dayjs().add(1, 'days').unix().toString(),\n      policy: formData.policy,\n      signature: formData.Signature,\n      accessId: formData.OSSAccessKeyId,\n    };\n  }\n}\n"})}),"\n",(0,a.jsxs)(n.h2,{id:"客户端上传图片",children:[(0,a.jsx)(n.a,{className:"header-anchor","aria-hidden":"true",href:"#客户端上传图片",children:"#"}),"客户端上传图片"]}),"\n",(0,a.jsx)(n.p,{children:"客户端上传图片时，会发送两个网络请求："}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"第一个请求的目的是获取签名，这一步骤我我使用 graphql 完成，由客户端发送给开发者服务器。"}),"\n",(0,a.jsx)(n.li,{children:"第二个请求的目标是上传图片，这一步骤我使用原生 fetch 完成，由客户端发送给 OSS 服务器。"}),"\n"]}),"\n",(0,a.jsx)(n.p,{children:"我将两个网络请求封装成一个名叫 useOSSUpload 的 hooks。"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",meta:"",children:"// 定义 graphql 获取签名的 gql\nimport { gql } from '@apollo/client'\n\nexport const GET_SIGNATURE = gql`\n  query getSignature {\n    getSignature {\n      expire\n      accessId\n      signature\n      policy\n      host\n    }\n  }\n`\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-ts",meta:"",children:"// 封装 useOSSUpload hooks，返回一个上传图片的函数 uploadHandler\nexport const useOSSUpload = () => {\n  const { data: d } = useQuery(GET_SIGNATURE)\n  const uploadHandler = async (file: File): Promise<{ url: string }> => {\n    const formData = new FormData()\n    const data = d.getSignature\n    const key = `images/${file.name}`\n    formData.append('key', key)\n    formData.append('policy', data.policy)\n    formData.append('OSSAccessKeyId', data.accessId)\n    formData.append('success_action_status', '200')\n    formData.append('Signature', data.signature)\n    formData.append('file', file)\n    const res = await fetch(data.host, {\n      method: 'POST',\n      body: formData,\n    })\n\n    return {\n      url: res.url + key,\n    }\n  }\n\n  return uploadHandler\n}\n"})}),"\n",(0,a.jsx)(n.p,{children:"通过使用 uploadHandler，我们可以上传图片。我们这里以 Antd 为例："}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-jsx",meta:"",children:"import { Form, ImageUploader } from 'antd-mobile'\nimport { useOSSUpload } from './hooks/useOSSUpload'\n\nfunction App() {\n  const uploadhandler = useOSSUpload()\n  return (\n    <Form>\n      <Form.Item label=\"上传图片\">\n        <ImageUploader upload={uploadhandler}></ImageUploader>\n      </Form.Item>\n    </Form>\n  )\n}\n\nexport default App\n"})})]})}function p(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:n}=Object.assign({},(0,t.ah)(),e.components);return n?(0,a.jsx)(n,Object.assign({},e,{children:(0,a.jsx)(d,e)})):d(e)}let h=p;p.__RSPRESS_PAGE_META={},p.__RSPRESS_PAGE_META["docs%2Fnestjs%2F02-oss.md"]={toc:[{id:"服务端获取签名",text:"服务端获取签名",depth:2},{id:"客户端上传图片",text:"客户端上传图片",depth:2}],title:"oss",frontmatter:{}}},95895:function(e,n,s){s.d(n,{Z:function(){return l}});var a=s(85893),t=s(67294),r=s(45687);s(6175);let i={"zh-CN":e=>`预计阅读时间: ${e.minutes>=1?`${Math.ceil(e.minutes)} 分钟`:"小于 1 分钟"}`,"en-US":e=>`Estimated reading time: ${e.minutes>=1?`${Math.ceil(e.minutes)} minutes`:"less than 1 minute"}`};function c(e,n,s){let a=Object.keys(i).includes(n)?n:s;return i[a](e)}let l=e=>{let{defaultLocale:n="en-US"}=e,s=(0,r.Vi)().page.readingTimeData,i=(0,r.Jr)(),l=(0,r.e7)(),[o,d]=(0,t.useState)(c(s,i,n));return(0,t.useEffect)(()=>{d(c(s,i,n))},[i,s]),(0,a.jsx)("span",{"data-dark":String(l),className:"rp-reading-time",children:o})}}}]);