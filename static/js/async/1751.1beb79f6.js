"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([["1751"],{7132:function(n,e,s){s.r(e),s.d(e,{default:()=>p});var a=s("5893"),r=s("65");let t=s.p+"static/image/oss4.aeba35ba.png",c=s.p+"static/image/oss3.32a90d89.png",l=s.p+"static/image/oss2.0fe1eea9.png",i=s.p+"static/image/oss1.1209815e.png";function o(n){let e=Object.assign({h1:"h1",a:"a",p:"p",code:"code",img:"img",ul:"ul",li:"li",h2:"h2",pre:"pre"},(0,r.ah)(),n.components);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(e.h1,{id:"oss",children:["oss",(0,a.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#oss",children:"#"})]}),"\n",(0,a.jsxs)(e.p,{children:["首先需要到阿里云的",(0,a.jsx)(e.code,{children:"身份管理/用户"}),"中创建一个用户账号，"]}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)("img",{src:i,alt:""})}),"\n",(0,a.jsx)(e.p,{children:"创建好用户后，我们可以给这个用户账号创建 AccessKey，这样就可以拿用户账号访问阿里云的 API 了。"}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)("img",{src:l,alt:""})}),"\n",(0,a.jsx)(e.p,{children:"有两种 API 上传图片到阿里云的方式。"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsxs)(e.li,{children:["服务端转发","\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"用服务端转发的话，请求我们自己的服务器会被收取一次费用，上传图片又会再收取一次费用"}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(e.li,{children:["Web 直传","\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"服务端会生成一个签名，然后将签名传递给客户端"}),"\n",(0,a.jsx)(e.li,{children:"客户端通过签名，上传图片到阿里云 OSS"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(e.p,{children:["我们这里选择 Web 直传的方式，文档可以参考",(0,a.jsx)(e.a,{href:"https://help.aliyun.com/document_detail/31926.html",target:"_blank",rel:"noopener noreferrer",children:"服务端签名后直传"})]}),"\n",(0,a.jsx)(e.p,{children:"之后需要给用户组设置权限。"}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)("img",{src:c,alt:""})}),"\n",(0,a.jsx)(e.p,{children:"然后需要设置跨域"}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)("img",{src:t,alt:""})}),"\n",(0,a.jsx)(e.p,{children:"之后读和写都需要权限，我们这里需要设置公共读"}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.a,{href:"https://help.aliyun.com/document_detail/177701.html?spm=a2c4g.149373.0.0.318f1955bLrLYc",target:"_blank",rel:"noopener noreferrer",children:"https://help.aliyun.com/document_detail/177701.html?spm=a2c4g.149373.0.0.318f1955bLrLYc"})}),"\n",(0,a.jsxs)(e.h2,{id:"服务端获取签名",children:["服务端获取签名",(0,a.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#服务端获取签名",children:"#"})]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"import { Injectable } from '@nestjs/common';\nimport * as OSS from 'ali-oss';\nimport * as dayjs from 'dayjs';\n\nimport {\n  aliyunAccessKeyId,\n  aliyunAccessKeySecret,\n  aliyunBucket,\n} from 'src/password.config';\nimport { OSSType } from './dto/oss.type';\n\n@Injectable()\nexport class OSSService {\n  async getSignature(): Promise<OSSType> {\n    const config = {\n      accessKeyId: aliyunAccessKeyId,\n      accessKeySecret: aliyunAccessKeySecret,\n      bucket: aliyunBucket,\n      dir: 'images/',\n    };\n    const client = new OSS(config);\n    const date = new Date();\n    date.setDate(date.getDate() + 1);\n    const policy = {\n      expiration: date.toISOString(), // 请求的超时时间。\n      conditions: [\n        ['content-length-range', 0, 1048576], // 设置上传文件的大小限制 1MB\n      ],\n    };\n\n    // 调用SDK获取签名\n    const formData = await client.calculatePostSignature(policy);\n\n    return {\n      expire: dayjs().add(1, 'days').unix().toString(),\n      policy: formData.policy,\n      signature: formData.Signature,\n      accessId: formData.OSSAccessKeyId,\n    };\n  }\n}\n"})}),"\n",(0,a.jsxs)(e.h2,{id:"客户端上传图片",children:["客户端上传图片",(0,a.jsx)(e.a,{className:"header-anchor","aria-hidden":"true",href:"#客户端上传图片",children:"#"})]}),"\n",(0,a.jsx)(e.p,{children:"客户端上传图片时，会发送两个网络请求："}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:"第一个请求的目的是获取签名，这一步骤我我使用 graphql 完成，由客户端发送给开发者服务器。"}),"\n",(0,a.jsx)(e.li,{children:"第二个请求的目标是上传图片，这一步骤我使用原生 fetch 完成，由客户端发送给 OSS 服务器。"}),"\n"]}),"\n",(0,a.jsx)(e.p,{children:"我将两个网络请求封装成一个名叫 useOSSUpload 的 hooks。"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"// 定义 graphql 获取签名的 gql\nimport { gql } from '@apollo/client'\n\nexport const GET_SIGNATURE = gql`\n  query getSignature {\n    getSignature {\n      expire\n      accessId\n      signature\n      policy\n      host\n    }\n  }\n`\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ts",children:"// 封装 useOSSUpload hooks，返回一个上传图片的函数 uploadHandler\nexport const useOSSUpload = () => {\n  const { data: d } = useQuery(GET_SIGNATURE)\n  const uploadHandler = async (file: File): Promise<{ url: string }> => {\n    const formData = new FormData()\n    const data = d.getSignature\n    const key = `images/${file.name}`\n    formData.append('key', key)\n    formData.append('policy', data.policy)\n    formData.append('OSSAccessKeyId', data.accessId)\n    formData.append('success_action_status', '200')\n    formData.append('Signature', data.signature)\n    formData.append('file', file)\n    const res = await fetch(data.host, {\n      method: 'POST',\n      body: formData,\n    })\n\n    return {\n      url: res.url + key,\n    }\n  }\n\n  return uploadHandler\n}\n"})}),"\n",(0,a.jsx)(e.p,{children:"通过使用 uploadHandler，我们可以上传图片。我们这里以 Antd 为例："}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-jsx",children:"import { Form, ImageUploader } from 'antd-mobile'\nimport { useOSSUpload } from './hooks/useOSSUpload'\n\nfunction App() {\n  const uploadhandler = useOSSUpload()\n  return (\n    <Form>\n      <Form.Item label=\"上传图片\">\n        <ImageUploader upload={uploadhandler}></ImageUploader>\n      </Form.Item>\n    </Form>\n  )\n}\n\nexport default App\n"})})]})}function d(){let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:e}=Object.assign({},(0,r.ah)(),n.components);return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(o,{...n})}):o(n)}let p=d;d.__RSPRESS_PAGE_META={},d.__RSPRESS_PAGE_META["docs%2Fnestjs%2F02-oss.md"]={toc:[{text:"服务端获取签名",id:"服务端获取签名",depth:2},{text:"客户端上传图片",id:"客户端上传图片",depth:2}],title:"oss",frontmatter:{}}}}]);