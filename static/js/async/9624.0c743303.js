"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([["9624"],{1965:function(e,r,n){n.r(r),n.d(r,{default:()=>p});var a=n("5893"),s=n("65");let i=n.p+"static/image/createImage.278d7999.jpg",h=n.p+"static/image/safari.534920d8.jpg",c=n.p+"static/image/toDataURL.6e0700eb.png",d=n.p+"static/image/can-i-use-toDataURL.8942f2c2.png",l=n.p+"static/image/can-i-use-webp.1066de7c.png";function t(e){let r=Object.assign({h1:"h1",a:"a",p:"p",ul:"ul",li:"li",img:"img",h2:"h2",h3:"h3",code:"code",pre:"pre",strong:"strong"},(0,s.ah)(),e.components);return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(r.h1,{id:"h5小程序能用-webp-图片吗如何判断环境是否支持",children:["H5、小程序能用 webp 图片吗？如何判断环境是否支持？",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#h5小程序能用-webp-图片吗如何判断环境是否支持",children:"#"})]}),"\n",(0,a.jsx)(r.p,{children:"最近我在做 H5、小程序的性能优化，其中一项优化是把 H5、小程序的 jpg、png 图片转换为 webp 图片，这是因为相比 jpg、png，webp 体积更小、传输速度更快。"}),"\n",(0,a.jsxs)(r.p,{children:["转换方法很简单，现在各大云服务商基本都提供了方法。比如 ",(0,a.jsx)(r.a,{href:"https://cloud.tencent.com/document/product/436/60453",target:"_blank",rel:"noopener noreferrer",children:"腾讯云"})," 只需要在图片 CDN 链接后面拼接一些参数："]}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:["转换前：",(0,a.jsx)(r.a,{href:"https://example-1258125638.cos.ap-shanghai.myqcloud.com/sample.png",target:"_blank",rel:"noopener noreferrer",children:"https://example-1258125638.cos.ap-shanghai.myqcloud.com/sample.png"})]}),"\n",(0,a.jsxs)(r.li,{children:["转换后：",(0,a.jsx)(r.a,{href:"http://example-1258125638.cos.ap-shanghai.myqcloud.com/sample.png?imageMogr2/format/webp",target:"_blank",rel:"noopener noreferrer",children:"http://example-1258125638.cos.ap-shanghai.myqcloud.com/sample.png?imageMogr2/format/webp"})]}),"\n"]}),"\n",(0,a.jsxs)(r.p,{children:["不过我还是遇到了些小麻烦，从 ",(0,a.jsx)(r.a,{href:"https://caniuse.com/?search=webp",target:"_blank",rel:"noopener noreferrer",children:"can I use"})," 查询发现，目前还有少部分浏览器不支持 webp。所以在 H5、小程序使用 webp 格式图片时，我需要做一些兼容。"]}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)("img",{src:l,alt:""})}),"\n",(0,a.jsx)(r.p,{children:"一番研究后，我知道了判断环境是否支持 webp 的几种办法。对这些办法的优劣，我也有自己的观点，于是我便整理了这篇文章。"}),"\n",(0,a.jsx)(r.p,{children:"拳打 H5，脚踢小程序。我是「小霖家的混江龙」，关注我，带你了解更多实用的 H5、小程序武学。"}),"\n",(0,a.jsxs)(r.h2,{id:"todataurlimagewebp",children:["toDataURL('image/webp')",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#todataurlimagewebp",children:"#"})]}),"\n",(0,a.jsxs)(r.h3,{id:"代码",children:["代码",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#代码",children:"#"})]}),"\n",(0,a.jsxs)(r.p,{children:["第一种 H5 的判断方法，其实是判断 H5 能不能利用 canvas 的 ",(0,a.jsx)(r.code,{children:"toDataURL()"})," API 得到一张 webp 图片。"]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-js",children:"function isWebpSupported() {\r\n  try {\r\n    return document.createElement('canvas')\r\n      .toDataURL('image/webp')\r\n      .indexOf('data:image/webp') === 0\r\n  } catch (e) {\r\n    return false\r\n  }\r\n}\n"})}),"\n",(0,a.jsxs)(r.h3,{id:"原理",children:["原理",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#原理",children:"#"})]}),"\n",(0,a.jsxs)(r.p,{children:["这种方法原理是啥呢？我们可以继续在 ",(0,a.jsx)(r.a,{href:"https://caniuse.com/?search=webp",target:"_blank",rel:"noopener noreferrer",children:"Can I use"})," 查询 ",(0,a.jsx)(r.code,{children:"toDataURL('image/webp')"})," 的兼容性。"]}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)("img",{src:d,alt:""})}),"\n",(0,a.jsxs)(r.p,{children:["可以看到，",(0,a.jsxs)(r.strong,{children:["兼容 ",(0,a.jsx)(r.code,{children:"toDataURL('image/webp')"})," 的浏览器、是兼容 webp 浏览器的子集。"]})]}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)("img",{src:c,alt:""})}),"\n",(0,a.jsxs)(r.p,{children:["换句话说，这是一种「宁杀错一百，也不放过一个」的方法。举 Safari 浏览器为例子，它其实是可以展示 webp 图片的，但它会被这种 ",(0,a.jsx)(r.code,{children:"toDataURL('image/webp')"})," 方法误伤。"]}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)("img",{src:h,alt:""})}),"\n",(0,a.jsxs)(r.h3,{id:"优缺点",children:["优缺点",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#优缺点",children:"#"})]}),"\n",(0,a.jsx)(r.p,{children:"这种方法的优缺点如下:"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"优点：代码短小，且方法是同步的，不影响首屏性能。"}),"\n",(0,a.jsx)(r.li,{children:"缺点：误伤性太高，iOS 的 Safari 浏览器被全部误伤。"}),"\n"]}),"\n",(0,a.jsxs)(r.h3,{id:"微信小程序能用吗",children:["微信小程序能用吗",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#微信小程序能用吗",children:"#"})]}),"\n",(0,a.jsx)(r.p,{children:"这种判断方法微信小程序可以使用吗？很遗憾不可以。"}),"\n",(0,a.jsxs)(r.p,{children:["我们之所以用 ",(0,a.jsx)(r.code,{children:"toDataURL('image/webp')"})," 判断 H5 能不能使用 webp，前提是我们知道 ",(0,a.jsxs)(r.strong,{children:["兼容 ",(0,a.jsx)(r.code,{children:"toDataURL('image/webp')"})," 的浏览器、是兼容 webp 浏览器的子集"]}),"。"]}),"\n",(0,a.jsxs)(r.p,{children:["但我在微信官方文档中，没有看到类似 canvas 的 ",(0,a.jsx)(r.a,{href:"https://developers.weixin.qq.com/miniprogram/dev/api/canvas/Canvas.toDataURL.html",target:"_blank",rel:"noopener noreferrer",children:"toDataURL('image/webp')"})," 是 webp 子集的描述。基于此，我判断微信小程序不能用这个方法。"]}),"\n",(0,a.jsxs)(r.h2,{id:"加载一张-webp-图片试试看会不会出错",children:["加载一张 webp 图片试试，看会不会出错",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#加载一张-webp-图片试试看会不会出错",children:"#"})]}),"\n",(0,a.jsxs)(r.h3,{id:"代码-1",children:["代码",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#代码-1",children:"#"})]}),"\n",(0,a.jsx)(r.p,{children:"第二种 H5 的判断方法，是直接异步加载一张 webp 格式的图片。如果加载成功，证明环境能支持 webp；如果加载失败，证明环境不支持 webp。"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-js",children:"function isWebpSupported() {\r\n  if (!Image) {\r\n    return Promise.resolve(false)\r\n  }\r\n\r\n  return new Promise((resolve) => {\r\n    const img = new Image()\r\n    img.onload = function () {\r\n      resolve((img.width > 0) && (img.height > 0))\r\n    }\r\n    img.onerror = function () {\r\n      resolve(false)\r\n    }\r\n    img.src = 'data:image/webp;base64,UklGRlIAAABXRUJQVlA4WAoAAAASAAAAAAAAAAAAQU5JTQYAAAD/////AABBTk1GJgAAAAAAAAAAAAAAAAAAAGQAAABWUDhMDQAAAC8AAAAQBxAREYiI/gcA';\r\n  })\r\n}\n"})}),"\n",(0,a.jsxs)(r.h3,{id:"原理-1",children:["原理",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#原理-1",children:"#"})]}),"\n",(0,a.jsxs)(r.p,{children:["这种方法来源于 ",(0,a.jsx)(r.a,{href:"https://developers.google.com/speed/webp/faq?hl=zh-cn#in_your_own_javascript",target:"_blank",rel:"noopener noreferrer",children:"Google 官方文档"}),"，webp 其实支持四个功能，无损压缩、有损压缩、透明度和动画，每个功能对应了一张 webp 图片："]}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-js",children:'function checkWebpFeature(feature, callback) {\r\n  const kTestImages = {\r\n    lossy: "UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",\r\n    lossless: "UklGRhoAAABXRUJQVlA4TA0AAAAvAAAAEAcQERGIiP4HAA==",\r\n    alpha: "UklGRkoAAABXRUJQVlA4WAoAAAAQAAAAAAAAAAAAQUxQSAwAAAARBxAR/Q9ERP8DAABWUDggGAAAABQBAJ0BKgEAAQAAAP4AAA3AAP7mtQAAAA==",\r\n    animation: "UklGRlIAAABXRUJQVlA4WAoAAAASAAAAAAAAAAAAQU5JTQYAAAD/////AABBTk1GJgAAAAAAAAAAAAAAAAAAAGQAAABWUDhMDQAAAC8AAAAQBxAREYiI/gcA"\r\n  }\r\n  const img = new Image()\r\n  img.onload = function () {\r\n    const result = (img.width > 0) && (img.height > 0)\r\n    callback(feature, result)\r\n  }\r\n  img.onerror = function () {\r\n    callback(feature, false)\r\n  }\r\n  img.src = "data:image/webp;base64," + kTestImages[feature]\r\n}\n'})}),"\n",(0,a.jsx)(r.p,{children:"如果对四种功能都进行判断的话，代码会变得很臃肿。所以实际开发中，基本只选择一张 webp 的图片。"}),"\n",(0,a.jsxs)(r.p,{children:["从 ",(0,a.jsx)(r.a,{href:"https://caniuse.com/?search=webp",target:"_blank",rel:"noopener noreferrer",children:"Can I use"})," 查询结果来看，浏览器要么是先支持 webp 的有损压缩，再支持 webp 的无损压缩、透明度和动画；要么是有损压缩、无损压缩、透明度和动画一起支持。因此，我们往往选择一张支持动画的 webp 图片，用它去试探浏览器是否支持 webp 格式。"]}),"\n",(0,a.jsxs)(r.h3,{id:"优缺点-1",children:["优缺点",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#优缺点-1",children:"#"})]}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"优点：基本不会误伤；"}),"\n",(0,a.jsx)(r.li,{children:"缺点：异步加载，可能无法及时转换图片链接、影响首屏性能。如果 H5 不选择 CSR，而选择 SSR，则无法使用此方法。"}),"\n"]}),"\n",(0,a.jsxs)(r.h3,{id:"微信小程序能用吗-1",children:["微信小程序能用吗",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#微信小程序能用吗-1",children:"#"})]}),"\n",(0,a.jsx)(r.p,{children:"这种方法小程序可以用吗？理论上可以，但不推荐使用。"}),"\n",(0,a.jsxs)(r.p,{children:["微信官方文档上虽然提到了 ",(0,a.jsx)(r.a,{href:"https://developers.weixin.qq.com/minigame/dev/api/render/image/wx.createImage.html",target:"_blank",rel:"noopener noreferrer",children:"createImage"})," 方法，但我实际测试发现，这个方法竟然没了 (* ￣︿￣)。"]}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)("img",{src:i,alt:""})}),"\n",(0,a.jsxs)(r.p,{children:["我们使用此方法，就必须在 wxml 中手动写一个 ",(0,a.jsx)(r.code,{children:"image"})," 标签，再给它绑定 ",(0,a.jsx)(r.code,{children:"onload"})," 和 ",(0,a.jsx)(r.code,{children:"onerror"})," 事件。这意味着："]}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"如果我们把这个标签放到自己封装的 WebpImage 组件中，WebpImage 被多次使用后，小程序页面会多出很多额外的节点。"}),"\n",(0,a.jsx)(r.li,{children:"如果我们把这个标签放到页面上（比如 index 页面），就需要给每一个用户可能直接访问的页面都加上这个标签。也会出现很多额外的节点。"}),"\n"]}),"\n",(0,a.jsx)(r.p,{children:"因此不推荐使用。"}),"\n",(0,a.jsxs)(r.h2,{id:"直接判断版本",children:["直接判断版本",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#直接判断版本",children:"#"})]}),"\n",(0,a.jsxs)(r.h3,{id:"代码-2",children:["代码",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#代码-2",children:"#"})]}),"\n",(0,a.jsx)(r.p,{children:"第三种方法，就是直接判断版本号，Android 版本大于 4.2.0，iOS 大于 14.0.0 时，认为 webp 可用。"}),"\n",(0,a.jsx)(r.p,{children:"H5 通过 ua 获取系统版本号的文章很多，我们这里给出小程序的代码。"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-js",children:"function isWebpSuported() {\r\n  try {\r\n    const { system, SDKVersion } = wx.getSystemInfoSync()\r\n    const [sysName, sysVersion] = (system || '').split(' ')\r\n    if (compareVersion(SDKVersion, '2.9.0') < 0) {\r\n      return false\r\n    }\r\n\r\n    if (\r\n      sysName.toUpperCase() === 'ANDROID' &&\r\n      compareVersion(sysVersion, '4.2.0') >= 0\r\n    ) {\r\n      return true\r\n    }\r\n\r\n    if (\r\n      sysName.toUpperCase() === 'IOS' &&\r\n      compareVersion(sysVersion, '14.0.0') >= 0\r\n    ) {\r\n      return true\r\n    }\r\n\r\n    return false\r\n  } catch (e) {\r\n    return false\r\n  }\r\n}\n"})}),"\n",(0,a.jsxs)(r.h3,{id:"原理-2",children:["原理",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#原理-2",children:"#"})]}),"\n",(0,a.jsxs)(r.p,{children:["我们已经通过 ",(0,a.jsx)(r.a,{href:"https://caniuse.com/?search=webp",target:"_blank",rel:"noopener noreferrer",children:"Can I use"})," 知道："]}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"Android 4.2.0 以下，iOS 14 以下的浏览器不支持 webp。"}),"\n"]}),"\n",(0,a.jsxs)(r.p,{children:["又从 ",(0,a.jsx)(r.a,{href:"https://developers.weixin.qq.com/miniprogram/dev/component/image.html#WebView-%E7%89%B9%E6%9C%89%E5%B1%9E%E6%80%A7",target:"_blank",rel:"noopener noreferrer",children:"微信小程序 image 组件文档"})," 里知道："]}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"基础库版本 >= 2.9.0 支持 webp。"}),"\n"]}),"\n",(0,a.jsxs)(r.p,{children:["那么干脆把所有条件都做一个组合，就得到了上述代码，其中 ",(0,a.jsx)(r.code,{children:"compareVersion()"})," 是 ",(0,a.jsx)(r.a,{href:"https://developers.weixin.qq.com/ebook?action=get_post_info&volumn=1&lang=zh_CN&book=miniprogram&docid=000288319f40c0eb00860cd135100a",target:"_blank",rel:"noopener noreferrer",children:"微信官方文档"})," 中比较版本号的代码。"]}),"\n",(0,a.jsxs)(r.h3,{id:"优缺点-2",children:["优缺点",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#优缺点-2",children:"#"})]}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsx)(r.li,{children:"优点：同步判断、不影响首屏性能；误伤范围小；且 CSR 和 SSR 可用。"}),"\n",(0,a.jsx)(r.li,{children:"缺点：无明显缺点。"}),"\n"]}),"\n",(0,a.jsxs)(r.h2,{id:"总结",children:["总结",(0,a.jsx)(r.a,{className:"header-anchor","aria-hidden":"true",href:"#总结",children:"#"})]}),"\n",(0,a.jsx)(r.p,{children:"本文介绍了 H5、小程序使用 webp 格式图片时，判断环境是否支持的方法。"}),"\n",(0,a.jsxs)(r.ul,{children:["\n",(0,a.jsxs)(r.li,{children:["方法一：利用 ",(0,a.jsx)(r.code,{children:"toDataURL('image/webp')"})," 判断。H5 支持，但是会误伤大部分浏览器；小程序不支持。"]}),"\n",(0,a.jsx)(r.li,{children:"方法二：利用一张小体积的 webp 图片试探。H5 CSR 时支持，但因为方法是异步的、可能影响首屏性能；H5 SSR 时不支持；小程序支持，但实现不优雅。"}),"\n",(0,a.jsxs)(r.li,{children:["方法三：",(0,a.jsx)(r.strong,{children:"利用版本号判断。H5 和浏览器均支持，是最佳实现方案。"})]}),"\n"]}),"\n",(0,a.jsx)(r.p,{children:"拳打 H5，脚踢小程序。我是「小霖家的混江龙」，关注我，带你了解更多实用的 H5、小程序武学。"})]})}function o(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{wrapper:r}=Object.assign({},(0,s.ah)(),e.components);return r?(0,a.jsx)(r,{...e,children:(0,a.jsx)(t,{...e})}):t(e)}let p=o;o.__RSPRESS_PAGE_META={},o.__RSPRESS_PAGE_META["blog%2F2024-03-10-is-webp-supported%2Findex.md"]={toc:[{text:"toDataURL('image/webp')",id:"todataurlimagewebp",depth:2},{text:"代码",id:"代码",depth:3},{text:"原理",id:"原理",depth:3},{text:"优缺点",id:"优缺点",depth:3},{text:"微信小程序能用吗",id:"微信小程序能用吗",depth:3},{text:"加载一张 webp 图片试试，看会不会出错",id:"加载一张-webp-图片试试看会不会出错",depth:2},{text:"代码",id:"代码-1",depth:3},{text:"原理",id:"原理-1",depth:3},{text:"优缺点",id:"优缺点-1",depth:3},{text:"微信小程序能用吗",id:"微信小程序能用吗-1",depth:3},{text:"直接判断版本",id:"直接判断版本",depth:2},{text:"代码",id:"代码-2",depth:3},{text:"原理",id:"原理-2",depth:3},{text:"优缺点",id:"优缺点-2",depth:3},{text:"总结",id:"总结",depth:2}],title:"H5、小程序能用 webp 图片吗？如何判断环境是否支持？",frontmatter:{}}}}]);