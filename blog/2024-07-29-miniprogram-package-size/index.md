# 超级小程序体积超限了怎么办？谈谈合规、但官方文档未提及的优化手段

开发小程序的朋友都知道，微信小程序有 2 个包体积限制[^1]：

- 单个主包、分包体积不能超过 2M
- 总体积不能超过 20M

有朋友认为 20M 体积绝对够用了，小程序肯定要「小而美」，不然叫什么小程序。但这只是理想情况。

借用「超级 APP」的概念，越来越多的小程序正在变成「超级小程序」。超级小程序集购物、出行、支付、社交等功能于一体。20M 真不够用。

## 为什么会出现超级小程序？

[QuestMobile 2024 年全景生态流量半年报](https://www.questmobile.com.cn/research/report/1815588709535420417) 提到：

> 用户 APP 使用习惯趋于稳定，月人均使用 APP 28.5 个；小程序用户规模持续增长，微信小程序、支付宝小程序、百度智能小程序、抖音小程序 6 月份月活用户规模分别达到 9.3 亿、6.64 亿、3.97 亿、2.35 亿。

简单来说，APP 的新用户变少了，但小程序的新用户还在变多。这种背景下，如果你是产品、你要在小程序上抢占更多用户，你会怎么办？一个自然而然的想法是——把 APP 的功能照搬到小程序上。

只要功能足够多，总有一个功能满足用户需要。「小而美」是不可能的，「大而全」才能抢占用户。

## 超级小程序包体积是怎么管理的？

和应用市场管超级 APP 不同，微信管超级小程序体积更严格，20M 的体积上限就定死在那里。

20M 体积实行了计划经济式管理，比如 A 业务占 2M 体积，B 业务分 2M 体积，C 业务占 4 MB 体积……。我们小组负责其中一个业务，业务体积上限已经锁死，不能想拆包就拆包。

## 为什么介绍合规的、官方文档未提到的手段？

因为官方文档提到的包体积优化手段[^2]（压缩体积、Tree Shaking、资源上传 CDN 等），**我们已经全部用过了**。

最开始效果还很明显，但随着业务迭代，这些手段减少的体积只是杯水车薪，往往我们减少 10KB，结果需求一下子就用了 200KB。

## 难道还有不合规的手段？

有是有，但各位朋友不要乱搞，大家一起维护社区秩序。否则微信官方可能直接封禁你的小程序。

这种做法是在小程序里面内置一个 JavaScript 解释器，从服务器动态拉取要执行的代码，最后通过 JavaScript 解释器执行代码。

2022 年 6 月，微信官方已经明令禁止使用在小程序内部使用 JavaScript 解释器。[^3]

闲话少说，下面开始介绍这些手段。

拳打 H5，脚踢小程序。我是「小霖家的混江龙」，关注我，带你了解更多实用的 H5、小程序武学。

## 手段一：推动 AB 实验全量、删除实验代码

AB 实验也就是对照实验，是产品常用策略。比如同一个页面分为 2 个组，50% 的人（对照组）进入出现红包，50% 的人（实验组）进入后出现抽奖，产品可以通过观察 2 个组的人最后下单的比例，判断是红包更吸引用户还是弹窗更吸引用户。

对研发来说，AB 实验会大量增加代码体积。拿刚才的例子来说，代码里必须同时有红包的代码、也有抽奖的代码。

有时候，产品可能被其他事项占用，迟迟不把 AB 实验全量，这会让体积一直被占用；有时候是实验已经全量了，但研发一直没有删除相关代码。

如果你能找到未全量的实验，减少的包体积就非常可观了。

## 手段二：小程序转 H5，再内嵌到 Webview 中

Webview 是小程序内置的组件，如果能够把小程序转成 H5，再内嵌到 Webview 里面，那么也能减少一部分体积。

这种办法有缺点：

如果你的小程序本身就使用跨端框架开发，那么成本会小一些，比如你可以用 Taro 编译一部分源代码转成 H5。

因为 Webview 内嵌 H5，H5 的性能肯定会比原生小程序差，所以往往会找边缘页面转成 H5，不过既然页面已经是边缘页面了，那么体积也不会特别大。

## 手段三：拆分小程序

既然一个小程序不够用，我再新申请一个小程序呢？

这种做法一种是调用 [wx.navigateToMiniProgram](https://developers.weixin.qq.com/miniprogram/dev/api/navigate/wx.navigateToMiniProgram.html) 打开其他小程序。

另外一种是调用 [wx.openEmbeddedMiniProgram](https://developers.weixin.qq.com/miniprogram/dev/api/navigate/wx.openEmbeddedMiniProgram.html) 打开半屏小程序。

其一，是再申请一个小程序很麻烦。

其二，如果直接打开其他小程序，会出现一个弹窗，有这个弹窗会导致一部分用户流水。

其三，如果直接用半屏小程序，半屏小程序是没有分享功能的。[^4]

## 总结

这三种合规的、但官方文档未提到的手段，可以看到都有很大的限制，需要长期的投入。

拳打 H5，脚踢小程序。我是「小霖家的混江龙」，关注我，带你了解更多实用的 H5、小程序武学。

[^1]: [分包加载 | 微信官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/subpackages.html)
[^2]: [代码包体积优化 | 微信官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/performance/tips/start_optimizeA.html)
[^3]: [关于禁止小程序JavaScript解释器使用规范要求](https://developers.weixin.qq.com/community/minihome/doc/0000ae500e4fd0541f2ea33755b801)
[^4]: [半屏小程序不支持分享功能](https://developers.weixin.qq.com/community/develop/doc/000c4ec37187c07e415e11a075bc00?commentid=000a86222086405e495e773c45b0)
